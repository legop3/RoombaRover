<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomba Rover</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/pcm-player.js"></script>
    <script src="/nipplejs.min.js"></script>
    <script src="/toaster.js"></script>
    <link href="/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: system-ui, sans-serif;
        }

        .btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            color: white;
        }
    </style>

    <meta property="og:title" content="Roomba Rover">
    <meta property="og:description" content="Control Roomba from anywhere">

    <!-- <meta property="og:image" content="/roomba-rover-og-image.png"> -->
    <!-- <meta property="og:url" content="https://roombarover.example.com"> -->
    <meta property="og:type" content="website">
    <!-- <meta name="twitter:card" content="summary_large_image"> -->
    <meta name="twitter:title" content="Roomba Rover">
    <meta name="twitter:description" content="Control your Roomba Rover with ease.">
    <!-- <meta name="twitter:image" content="/roomba-rover-og-image.png"> -->
    <meta name="theme-color" content="#0390fc">
    <!-- <link rel="icon" href="/favicon.ico"> -->

</head>

<body class="bg-black text-white">
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-4"></div>
    <!-- <div class="flex justify-end p-2">
        <button onclick="toggleDarkMode()" class="bg-blue-500 hover:bg-blue-700">Toggle Dark Mode</button>
    </div> -->

<!-- 
    <div class="flex flex-col lg:flex-row p-1 gap-6">
        <div class="flex-1 space-y-4"> -->
    
    <div class="max-w-8xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-1 items-start">
            <!-- <div class="grid gap-4 grid-cols-[repeat(auto-fit,minmax(300px,1fr))]"> -->
            <!-- video and sensor card -->
        <!-- <div class="grid gap-2 grid-cols-1 sm:grid-cols-2items-start"> -->
            <!-- <div class="flex flex-col lg:flex-row"> -->
            <div class="rounded-xl shadow-md p-1 bg-gray-700">
                <p class="text-lg font-semibold"></p>

                <div class="relative">
                    <img id="video" class="w-full max-w-full rounded-md" />
                    <!-- <img id="rearvideo" class="absolute top-3 left-1/2 translate-x-1/2 w-24 flex justify-center" src="placeholder"></img> -->

                    <div id="blinker" class="absolute top-3 right-3 w-5 h-5 rounded-full bg-green-500 bg-red-500 opacity-800"></div>
                    <div id="sensorblinker" class="p-1 rounded-full bg-pink-400 bg-black w-5 h-5 absolute right-10 top-3 opacity-80"></div>
                    
                    <!-- <div class="p-1 bg-red-300 h-5 w-1/2 absolute right-3 bottom-10">
                        <div class="h-full bg-green-500" style="width: 0%;" id="wall-distance"></div>
                    </div> -->

                    <!-- <div class="absolute bottom-3 left-3 bg-gray-500"> -->
                        <div class="absolute bottom-3 left-3 w-5 h-10 bg-gray-500 items-start">
                            <div class="bg-green-500" style="height: 0%;" id="leftCurrent-bar"></div>
                        </div>
                        <div class="absolute bottom-3 left-10 w-5 h-10 bg-gray-500 items-start">
                            <div class="bg-green-500" style="height: 0%;" id="rightCurrent-bar"></div>
                        </div>
                    <!-- </div> -->

                    <p id="connectstatus" class="absolute top-3 left-3 rounded-full bg-red-500 bg-green-500 p-2 opacity-80">Disconnected</p>
                    <video id="localcam" class="absolute top-3 left-1/2 rounded-md w-40" autoplay muted></video>

                    <div class="absolute bottom-3 right-3 bg-gray-500 p-0 rounded-full opacity-50">
                        <input type="text" id="messageInput" class="p-2 bg-gray-600 rounded" placeholder="Type your message here">
                        <input type="checkbox" name="Beep?" id="beepcheck" checked>
                        <button id="sendMessageButton" class="btn bg-blue-500">Send</button>
                    </div>


                </div>

                <div id="bump-sensors" class="flex gap-1 text-xs md:text-base relative">
                    <div class="w-1/6 h-5 bg-gray-500 flex flex-row-reverse items-end">
                      <div id="lightbump-L" class="h-full bg-green-500" style="width: 0%;"></div>
                    </div>
                    <div class="w-1/6 h-5 bg-gray-500 flex flex-row-reverse items-end">
                      <div id="lightbump-FL" class="h-full bg-green-500" style="width: 0%;"></div>
                    </div>
                    <div class="w-1/6 h-5 bg-gray-500 flex flex-row-reverse items-end">
                      <div id="lightbump-CL" class="h-full bg-green-500" style="width: 0%;"></div>
                    </div>
                    <div class="w-1/6 h-5 bg-gray-500 flex items-end">
                      <div id="lightbump-CR" class="h-full bg-green-500" style="width: 0%;"></div>
                    </div>
                    <div class="w-1/6 h-5 bg-gray-500 flex items-end">
                      <div id="lightbump-FR" class="h-full bg-green-500" style="width: 0%;"></div>
                    </div>
                    <div class="w-1/6 h-5 bg-gray-500 flex items-end">
                      <div id="lightbump-R" class="h-full bg-green-500" style="width: 0%;"></div>
                    </div>
                  </div>
                  

                <div id="sensor-data" class="flex flex-wrap gap-1 text-xs md:text-base relative">
                    <p id="charge-status" class="p-1 bg-gray-500 rounded">No Data</p>
                    <p id="battery-usage" class="p-1 bg-gray-500 rounded">No Data</p>
                    <p id="oi-mode" class="p-1 bg-gray-500 rounded">No Data</p>
                    <p id="dock-status" class="p-1 bg-gray-500 rounded">No Data</p>
                    <p id="battery-voltage" class="p-1 bg-gray-500 rounded">No Data</p>
                    <p id="brush-current" class="p-1 bg-gray-500 rounded">No Data</p>
                    <p id="battery-current" class="p-1 bg-gray-500 rounded">No Data</p>
                </div>
            </div>

            <!-- joystick card -->
            <div class="rounded-xl bg-gray-600 shadow-md p-1 h-80 md:hidden flex">
                <!-- Joystick area -->

                <div class="flex flex-col text-xl rounded-xl">
                    <button class="h-1/3 bg-indigo-300 rounded-xl" id="brushForwardButton">ðŸ”„</button>
                    <button class="h-1/3 bg-indigo-300 rounded-xl" id="brushReverseButton">ðŸ”ƒ</button>
                    <button class="h-1/3 bg-indigo-300 rounded-xl" id="vacuumMotorButton">ðŸ’¨</button>
                </div>

                <div id="joystick" class="relative w-full h-full">
                    <h2 class="text-xl font-bold mb-2 text-center">Joystick area</h2>
                </div>



            </div>


            <div class="flex flex-col gap-1">
            <!-- buttons card -->
            <div class="rounded-xl shadow-md p-1 bg-gray-700">
                <p class="text-lg font-semibold text-center">Basic Controls</p>
                <div class="items-center content-center w-full justify-center flex gap-2">
                    <button id="" class="btn bg-green-600 w-1/2" onclick="easyStart()">
                        <p class="text-xl">Start Driving</p>
                        <p>Press to enable driving mode</p>
                        <p class="bg-green-500 bg-red-500 rounded-xl" id="start-button-message">Not Ready!</p>
                    </button>
                    <button id="" class="btn bg-indigo-600 w-1/2" onclick="easyDock()">
                        <p class="text-xl">Dock and Charge</p>
                        <p>Line up a few inches from the dock, and press this button to enter docking mode</p>
                        <div class="flex">
                            <p class="bg-green-500 bg-red-500 rounded-xl w-1/2" id="dock-button-message">Not Docked!</p>
                            <p class="bg-green-500 bg-red-500 rounded-xl w-1/2" id="dock-button-charging-message">Not Charging!</p>
                        </div>
                    </button>
                </div>

                <!-- <p>Use <strong>W, A, S, D</strong> to drive. Hold <strong>Shift</strong> for slow, <strong>\</strong> for fast. <br>Use <strong>O</strong> and <strong>L</strong> to move the side brush forward and reverse.<br>Use <strong>I</strong> and <strong>K</strong> to run the vacuum motor fast or slow<br>Use Enter to start typing a message, and press enter again to send it to the roomba screen.</p> -->
                            
                <!-- Desktop Controls (hidden on small screens) -->
                <div class="hidden md:block">
                    <p class="text-lg font-semibold text-center mt-4">Keyboard Controls</p>
                    <div class="text-white bg-gray-600 rounded-xl p-2">
                        <p class="font-semibold underline">Driving Controls:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>W, A, S, D</strong> â€” Drive the robot (forward, left, backward, right)</li>
                            <li><strong>Hold Shift</strong> â€” Drive slowly</li>
                            <li><strong>Hold \ (Backslash)</strong> â€” Drive quickly</li>
                        </ul>

                        <p class="font-semibold underline mt-2">Side Brush (Hold):</p>
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>O</strong> â€” Rotate side brush forward</li>
                            <li><strong>L</strong> â€” Rotate side brush in reverse</li>
                        </ul>

                        <p class="font-semibold underline mt-2">Vacuum Motor (Hold):</p>
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>I</strong> â€” Run vacuum motor at high speed</li>
                            <li><strong>K</strong> â€” Run vacuum motor at low speed</li>
                        </ul>

                        <p class="font-semibold underline mt-2">Roomba Screen Messaging:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>Enter</strong> â€” Start typing a message to display</li>
                            <li><strong>Enter (again)</strong> â€” Send the message to the Roomba screen</li>
                        </ul>
                    </div>
                </div>

                <!-- Mobile Controls (hidden on medium and up) -->
                <div class="block md:hidden">
                    <p class="text-lg font-semibold text-center mt-4">Touch Controls</p>
                    <div class="text-sm text-white bg-gray-600 rounded-xl p-2">
                        <p class="text-center">Use the on-screen buttons to control driving, docking, and other features.</p>
                        <ul class="list-disc list-inside ml-4 mt-2">
                            <!-- <li>Tap <strong>Start Driving</strong> to begin manual control.</li> -->
                            <!-- <li>Tap <strong>Dock</strong> to initiate docking mode.</li> -->
                            <!-- <li>Use <strong>audio, video, and sensor</strong> buttons to toggle features.</li> -->
                            <li>Hold the ðŸ”„ and ðŸ”ƒ buttons to rotate the side brush.</li>
                            <li>Hold the ðŸ’¨ button to run the vacuum motor.</li>
                            <li>Use the joystick above to drive the Roomba.</li>
                            <!-- <li>Toggle the <strong>REBOOT SERVER</strong> only when confirmed.</li> -->
                        </ul>
                    </div>
                </div>

                <p class="text-lg font-semibold text-center">Advanced Controls (Careful!)</p>
                <div class="flex gap-2 mt-2 flex-wrap">
                    <button onclick="dockNow()" class="btn bg-indigo-400">Dock / Passive</button>
                    <button onclick="reconnectRoomba()" class="btn bg-pink-400">Reconnect / Full</button>
                    <button onclick="startAudio()" class="btn bg-green-500">Start Audio</button>
                    <button onclick="stopAudio()" class="btn bg-red-600">Stop Audio</button>
                    <button onclick="startVideo()" class="btn bg-green-500">Start Video</button>
                    <button onclick="stopVideo()" class="btn bg-red-600">Stop Video</button>
                    <button onclick="sensorData()" class="btn bg-blue-600">Start Sensor Data</button>
                    <button onmousedown="sideBrush('forward')" onmouseup="sideBrush('stop')" class="btn bg-red-300">Side brush (hold)</button>
                    <button onclick="startWebcam()" class="btn bg-green-500">Start your webcam</button>
                    <!-- <button onclick="stopWebcam()" class="btn bg-red-600">Stop webcam</button> -->

                    <div class = "rounded-xl bg-gray-500 p-1">
                        <input type="checkbox" id="rebootconfirm">
                        <button onclick="rebootServer()" class="btn bg-pink-900">REBOOT SERVER</button>
                    </div>

                </div>

            
            </div>

            <!-- message card -->
            <div class="rounded-xl shadow-md p-4 bg-gray-700">
                <p class="text-lg font-semibold text-center">Server Message</p>
                <p class="font-medium text-blue-400" id="message"></p>
            </div>

            <!-- ffmpeg card -->
            <div class="rounded-xl shadow-md p-4 bg-gray-700">
                <p class="text-lg font-semibold text-center">FFMPEG Message</p>
                <p class="font-medium text-blue-400" id="ffmpeg"></p>
            </div>
            </div>
            <!-- your camera card  -->
            <!-- <div class="rounded-x1 shadow-md p-1 bg-gray-700">
                <p class="text-lg font-semibold text-center">Your Camera</p>
                <video id="localcam" class="w-full max-w-full rounded-md" autoplay muted></video>
                <button onclick="startWebcam()" class="btn bg-green-500">Start webcam</button>
                <button onclick="stopWebcam()" class="btn bg-red-600">Stop webcam</button>
            </div> -->

            <!-- <div class="rounded-x1 shadow-md p-1 bg-gray-700">
                <p class="text-lg font-semibold text-center">Send Message</p> -->
                <!-- <input type="text" id="messageInput" class="p-2 bg-gray-600 rounded w-full" placeholder="Type your message here">
                <button id="sendMessageButton" class="btn bg-blue-500 mt-2">Send</button> -->
            <!-- </div> -->


        </div>


    </div>

    <script>

        // Cache DOM elements once after the DOM is ready
        const dom = {
        oiMode: document.getElementById('oi-mode'),
        dockStatus: document.getElementById('dock-status'),
        chargeStatus: document.getElementById('charge-status'),
        batteryUsage: document.getElementById('battery-usage'),
        batteryVoltage: document.getElementById('battery-voltage'),
        brushCurrent: document.getElementById('brush-current'),
        batteryCurrent: document.getElementById('battery-current'),
        bumpSensors: {
            L: document.getElementById('lightbump-L'),
            FL: document.getElementById('lightbump-FL'),
            CL: document.getElementById('lightbump-CL'),
            CR: document.getElementById('lightbump-CR'),
            FR: document.getElementById('lightbump-FR'),
            R: document.getElementById('lightbump-R')
        },
        leftCurrentBar: document.getElementById('leftCurrent-bar'),
        rightCurrentBar: document.getElementById('rightCurrent-bar'),
        startButtonMessage: document.getElementById('start-button-message'),
        dockButtonMessage: document.getElementById('dock-button-message'),
        dockButtonChargingMessage: document.getElementById('dock-button-charging-message'),
        // wallSignal: document.getElementById('wall-distance')
        };


        var socket = io()
        const player = new PCMPlayer({
            encoding: '16bitInt',
            channels: 1,
            sampleRate: 16000,
            flushTime: 20
        });

        socket.on('connect', () => {
            console.log('Connected to server')
            document.getElementById('connectstatus').innerText = 'Connected'
            document.getElementById('connectstatus').classList.remove('bg-red-500')
            document.getElementById('connectstatus').classList.add('bg-green-500')

            sensorData()
            startVideo()
            stopAudio()
            startAudio()

        });
        socket.on('disconnect', () => {
            console.log('Disconnected from server')
            document.getElementById('connectstatus').innerText = 'Disconnected'
            document.getElementById('connectstatus').classList.remove('bg-green-500')
            document.getElementById('connectstatus').classList.add('bg-red-500')
        });

        // key handler function
        const pressedKeys = new Set();
        function handleKeyEvent(event, isKeyDown) {
            const key = event.key.toLowerCase();
            if (['w', 'a', 's', 'd', 'shift', '\\'].includes(key)) {
                if (isKeyDown && !pressedKeys.has(key)) pressedKeys.add(key);
                else if (!isKeyDown) pressedKeys.delete(key);
                else return;

                const speeds = keySpeedCalculator(pressedKeys);
                // console.log(`Left: ${speeds.leftSpeed}, Right: ${speeds.rightSpeed}`);
                socket.emit('Speedchange', speeds);
            }

            // key controls for side brush
            if (['o', 'l'].includes(key)) {
                if (isKeyDown && !pressedKeys.has(key)) pressedKeys.add(key);
                else if (!isKeyDown) pressedKeys.delete(key);
                else return;

                if (pressedKeys.has('o')) speed = 127
                if (pressedKeys.has('l')) speed = -50
                if (!pressedKeys.has('o') && !pressedKeys.has('l')) speed = 0

                socket.emit('sideBrush', { speed: speed })

            } 

            //key controls for vacuum motor
            if (['i', 'k'].includes(key)) {
                if (isKeyDown && !pressedKeys.has(key)) pressedKeys.add(key);
                else if (!isKeyDown) pressedKeys.delete(key);
                else return;

                if (pressedKeys.has('i')) speed = 127
                if (pressedKeys.has('k')) speed = 20
                if (!pressedKeys.has('i') && !pressedKeys.has('k')) speed = 0

                socket.emit('vacuumMotor', { speed: speed })

            }

            //press enter to start typing a message, then press enter again to send it
            // let inputFocused = false
            let sendButton = document.getElementById('sendMessageButton')
            let messageInput = document.getElementById('messageInput')
            if (['enter'].includes(key)) {
                if (isKeyDown && !pressedKeys.has(key)) pressedKeys.add(key);
                else if (!isKeyDown) pressedKeys.delete(key);
                else return;

                if (document.activeElement === messageInput && isKeyDown) {
                    sendButton.click()
                    if (messageInput.value === '') {
                        messageInput.blur()
                    }
                    messageInput.blur()
                } else if (document.activeElement !== messageInput && isKeyDown) {
                    messageInput.focus()

                }
            }
        }

        document.addEventListener('keydown', e => handleKeyEvent(e, true));
        document.addEventListener('keyup', e => handleKeyEvent(e, false));

        function keySpeedCalculator(keys) {
            const baseSpeed = 100;
            const fast = 2.5, slow = 0.5;
            let left = 0, right = 0, mult = 1;
            if (keys.has('\\')) mult = fast;
            else if (keys.has('shift')) mult = slow;
            if (keys.has('w')) left += baseSpeed, right += baseSpeed;
            if (keys.has('s')) left -= baseSpeed, right -= baseSpeed;
            if (keys.has('a')) left -= baseSpeed, right += baseSpeed;
            if (keys.has('d')) left += baseSpeed, right -= baseSpeed;
            return { leftSpeed: left * mult, rightSpeed: right * mult };
        }

        function dockNow() { socket.emit('Docking', { action: 'dock' }); }
        function reconnectRoomba() { socket.emit('Docking', { action: 'reconnect' }); }
        function sensorData() { socket.emit('requestSensorData'); }
        function startVideo() { socket.emit('startVideo'); }
        function stopVideo() { socket.emit('stopVideo'); }
        function startAudio() { socket.emit('startAudio'); }
        function stopAudio() { socket.emit('stopAudio'); }
        function sideBrush(state) { socket.emit('sideBrush', { action:state }); }

        function easyStart() { socket.emit('easyStart'); }
        function easyDock() { socket.emit('easyDock'); }

        const dotblinker = document.getElementById('blinker');
        dotblinker.classList.toggle('bg-red-500')
        socket.on('videoFrame:frontCamera', data => {
            document.getElementById('video').src = 'data:image/jpeg;base64,' + data;       
            
            dotblinker.classList.toggle('bg-red-500')
            dotblinker.classList.toggle('bg-green-500')
        });

        socket.on('videoFrame:rearCamera', data => {
            document.getElementById('rearvideo').src = 'data:image/jpeg;base64,' + data;
        })

        socket.on('audio', base64 => {
            try {
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                player.feed(new Int16Array(bytes.buffer));
                player.flush();
            } catch (err) {
                console.error('Error processing audio:', err);
            }
        });

        sensorblinker = document.getElementById('sensorblinker');
        sensorblinker.classList.toggle('bg-pink-400')

        // let LBL = document.getElementById('lightbump-L')
        // let LBFL = document.getElementById('lightbump-FL')
        // let LBCL = document.getElementById('lightbump-CL')
        // let LBCR = document.getElementById('lightbump-CR')
        // let LBFR = document.getElementById('lightbump-FR')
        // let LBR = document.getElementById('lightbump-R')


        var MAX_VALUE = 300
        var MAX_VALUE_WCURRENT = 800
        socket.on('SensorData', data => {
            const chargeStatus = ['Not Charging', 'Reconditioning Charging', 'Full Charging', 'Trickle Charging', 'Waiting', 'Charging Error'][data.chargeStatus] || 'Unknown';
            const chargingSources = data.chargingSources === 2 ? 'Docked' : 'None';
            const oiMode = data.oiMode === 2 ? 'Passive' : (data.oiMode === 4 ? 'Full' : 'Unknown');

            document.getElementById('oi-mode').innerText = `Mode: ${oiMode}`;
            document.getElementById('dock-status').innerText = `Dock: ${chargingSources}`;
            document.getElementById('charge-status').innerText = `Charging: ${chargeStatus}`;
            document.getElementById('battery-usage').innerText = `Charge: ${data.batteryCharge} / ${data.batteryCapacity}`;
            document.getElementById('battery-voltage').innerText = `Voltage: ${data.batteryVoltage / 1000}V`;
            document.getElementById('brush-current').innerText = `Brush: ${data.brushCurrent}mA`;
            document.getElementById('battery-current').innerText = `Current: ${data.batteryCurrent}mA`;

            updateBumpSensors(data.bumpSensors);

            // console.log(`motor currents: Left: ${data.leftCurrent}mA, Right: ${data.rightCurrent}mA`);

            // console.log('Wall signal:', data.wallSignal);
            // dom.wallSignal.style.width = `${(data.wallSignal / MAX_VALUE) * 100}%`;
            dom.leftCurrentBar.style.height = `${(data.leftCurrent / MAX_VALUE_WCURRENT) * 100}%`;
            dom.rightCurrentBar.style.height = `${(data.rightCurrent / MAX_VALUE_WCURRENT) * 100}%`;

            if(oiMode === 'Full') {
                dom.startButtonMessage.innerText = 'Ready to Drive!';
                dom.startButtonMessage.classList.remove('bg-red-500');
                dom.startButtonMessage.classList.add('bg-green-500');
            } else {
                dom.startButtonMessage.innerText = 'Not in Driving Mode!';
                dom.startButtonMessage.classList.remove('bg-green-500');
                dom.startButtonMessage.classList.add('bg-red-500');
            }

            if(chargingSources === 'Docked') {
                dom.dockButtonMessage.innerText = 'Docked!';
                dom.dockButtonMessage.classList.remove('bg-red-500');
                dom.dockButtonMessage.classList.add('bg-green-500');
                if(chargeStatus === 'Not Charging') {
                    dom.dockButtonChargingMessage.innerText = 'Not Charging!';
                    dom.dockButtonChargingMessage.classList.remove('bg-green-500');
                    dom.dockButtonChargingMessage.classList.add('bg-red-500');
                } else {
                    dom.dockButtonChargingMessage.innerText = chargeStatus;
                    dom.dockButtonChargingMessage.classList.remove('bg-red-500');
                    dom.dockButtonChargingMessage.classList.add('bg-green-500');
                }
            } else {
                dom.dockButtonMessage.innerText = 'Not Docked!';
                dom.dockButtonMessage.classList.remove('bg-green-500');
                dom.dockButtonMessage.classList.add('bg-red-500');
            }


            // console.log('Light Bump Sensors:', data.bumpSensors);

            // const averageLightBump = data.bumpSensors.reduce((acc, val) => acc + val, 0) / data.bumpSensors.length;
            // console.log('Average Light Bump:', averageLightBump);

            //set max value range based on the average light bump value

            // var max_values = {
            //     0: 0,
            //     1: 0,
            //     2: 0,
            //     3: 0,
            //     4: 0,
            //     5: 0
            // }

            // data.bumpSensors.forEach((element, index) => {
            //     // console.log('Light Bump Sensor Value:', element);
            //     if (element < 100) {
            //     max_values[index] = 100;
            //     } else if (element < 500) {
            //         max_values[index] = 500;
            //     } else if (element < 1000) {
            //         max_values[index] = 1000;
            //     } else if (element < 1500) {
            //         max_values[index] = 1500;
            //     } else {
            //         max_values[index] = 2000;
            //     } 
            // });


            // // console.log('Max Value:', max_values);


            // LBL.style.width = `${(data.bumpSensors[0] / max_values[0]) * 100}%`;
            // // LBL.innerHTML = `${max_values[0]}`
            // LBL.style.backgroundColor = `hsl(${(max_values[0]) / 2}, 100%, 50%)`;

            // LBFL.style.width = `${(data.bumpSensors[1] / max_values[1]) * 100}%`;
            // // LBFL.innerHTML = `${max_values[1]}`
            // LBFL.style.backgroundColor = `hsl(${(max_values[1]) / 2}, 100%, 50%)`;

            // LBCL.style.width = `${(data.bumpSensors[2] / max_values[2]) * 100}%`;
            // // LBCL.innerHTML = `${max_values[2]}`
            // LBCL.style.backgroundColor = `hsl(${(max_values[2]) / 2}, 100%, 50%)`;

            // LBCR.style.width = `${(data.bumpSensors[3] / max_values[3]) * 100}%`;
            // // LBCR.innerHTML = `${max_values[3]}`
            // LBCR.style.backgroundColor = `hsl(${(max_values[3]) / 2}, 100%, 50%)`;

            // LBFR.style.width = `${(data.bumpSensors[4] / max_values[4]) * 100}%`;
            // // LBFR.innerHTML = `${max_values[4]}`
            // LBFR.style.backgroundColor = `hsl(${(max_values[4]) / 2}, 100%, 50%)`;

            // LBR.style.width = `${(data.bumpSensors[5] / max_values[5]) * 100}%`;
            // // LBR.innerHTML = `${max_values[5]}`
            // LBR.style.backgroundColor = `hsl(${(max_values[5]) / 2}, 100%, 50%)`;




            sensorblinker.classList.toggle('bg-pink-400')
            sensorblinker.classList.toggle('bg-black')
        });


        // Mapping of sensor index to DOM ID (same order as data.bumpSensors)
        const bumpKeys = ['L', 'FL', 'CL', 'CR', 'FR', 'R'];
        const bumpElements = bumpKeys.reduce((acc, key) => {
        acc[key] = document.getElementById(`lightbump-${key}`);
        return acc;
        }, {});

        // Range-based function to determine max value for scaling
        function getMaxForRange(value) {
        if (value < 100) return 100;
        if (value < 500) return 500;
        if (value < 1000) return 1000;
        if (value < 1500) return 1500;
        return 2000;
        }

        // Update bump sensor visuals based on their values
        function updateBumpSensors(bumpValues) {
        bumpKeys.forEach((key, index) => {
            const value = bumpValues[index];
            const el = bumpElements[key];

            // Use threshold-based scaling
            const max = getMaxForRange(value);
            const widthPercent = (value / max) * 100;
            const newColor = `hsl(${max / 2}, 100%, 50%)`;

            // Only update if the width would significantly change
            if (Math.abs(parseFloat(el.style.width || 0) - widthPercent) > 1) {
            el.style.width = `${widthPercent}%`;
            el.style.backgroundColor = newColor;
            }
        });
        }



        socket.on('message', data => {
            document.getElementById('message').innerText = data;
            showToast(data, 'info')
        });

        socket.on('alert', data => {
            document.getElementById('message').innerText = data;
            showToast(data, 'error', false)
        });

        socket.on('ffmpeg', data => {
            document.getElementById('ffmpeg').innerText = data;
        });

        // Joystick control
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick'),
            mode: 'dynamic',
            // position: { left: '50%', top: '50%' },
            color: 'pink',
            size: '200'
        });

        // wheel speed calculations
        const MAX_SPEED = 200
        joystick.on('move', function (evt, data) {
            if (!data || !data.distance || !data.angle) return;
            let leftSpeed = data.vector.y * MAX_SPEED + data.vector.x * MAX_SPEED;
            let rightSpeed = data.vector.y * MAX_SPEED - data.vector.x * MAX_SPEED;

            leftSpeed = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, leftSpeed));
            rightSpeed = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, rightSpeed));

            leftSpeed = Math.round(leftSpeed);
            rightSpeed = Math.round(rightSpeed);

            // console.log(data.vector.x, data.vector.y);
            // console.log(`Left: ${leftSpeed}, Right: ${rightSpeed}`);
            socket.emit('Speedchange', { leftSpeed, rightSpeed });
        });

        joystick.on('end', function () {
            socket.emit('Speedchange', { leftSpeed: 0, rightSpeed: 0 });
        });

        function rebootServer() {
            const confirm = document.getElementById('rebootconfirm').checked;
            if (confirm) {
                socket.emit('rebootServer');
                document.getElementById('rebootconfirm').checked = false;
                alert("Rebooting Roomba's server. This will take a few minutes.");
            } else {
                alert("Please check the confirmation box to reboot the server.");
            }
        }

        // Stream your webcam stuff (WIP)
        function sendFrame() {
            const video = document.getElementById('localcam');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const data = canvas.toDataURL('image/jpeg', 0.5);
            socket.emit('userWebcam', data);
        }



        async function startWebcam() {
            const video = document.getElementById('localcam');

            const stream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: false
            });
            video.srcObject = stream;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            setInterval(() => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const data = canvas.toDataURL('image/jpeg', 0.5);
                socket.emit('userWebcam', data);
                // console.log(data);
            }, 1000 / 2); 
        }

        function stopWebcam() {
            console.log('stopping webcam')
        }



        // send a message to the roomba screen
        document.getElementById('sendMessageButton').addEventListener('click', () => {
            const message = document.getElementById('messageInput').value
            socket.emit('userMessage', { message, beep: document.getElementById('beepcheck').checked });
            document.getElementById('messageInput').value = '';
        });

        // send typing status to roomba screen
        document.getElementById('messageInput').addEventListener('input', () => {
            const message = document.getElementById('messageInput').value
            socket.emit('userTyping', { message, beep: document.getElementById('beepcheck').checked });
        });

        // handle events from aux motor buttons on the joystick card
        document.getElementById('brushForwardButton').addEventListener('pointerdown', () => {
            socket.emit('sideBrush', { speed: 127 });
        })
        document.getElementById('brushForwardButton').addEventListener('pointerup', () => {
            socket.emit('sideBrush', { speed: 0 });
        })
        document.getElementById('brushReverseButton').addEventListener('pointerdown', () => {
            socket.emit('sideBrush', { speed: -127 });
        })
        document.getElementById('brushReverseButton').addEventListener('pointerup', () => {
            socket.emit('sideBrush', { speed: 0 });
        })
        document.getElementById('vacuumMotorButton').addEventListener('pointerdown', () => {
            socket.emit('vacuumMotor', { speed: 127 });
        })
        document.getElementById('vacuumMotorButton').addEventListener('pointerup', () => {
            socket.emit('vacuumMotor', { speed: 0 });
        })
    </script>
</body>

</html>
