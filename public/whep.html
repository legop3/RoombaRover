<div style="max-width:960px;margin:0 auto">
    <video id="rv" playsinline autoplay style="width:100%;background:#000;border-radius:8px"></video>
    <div id="rvStatus" style="font:12px/1.2 monospace;opacity:.8;margin-top:6px">idle</div>
  </div>
  
  <script>
  (async () => {
    const video  = document.getElementById('rv');
    const status = document.getElementById('rvStatus');
    const log = (m,...a)=>{ status.textContent = m; console.log('[WHEP]', m, ...a); };
    const err = (m,...a)=>{ status.textContent = m; console.error('[WHEP]', m, ...a); };
  
    async function getWhepUrl() {
      const r = await fetch('/video-url', { cache: 'no-store' });
      const t = (await r.text()).trim();
      if (!r.ok || !t || /^</.test(t)) throw new Error('/video-url returned invalid content');
      return t; // e.g. https://rover.otter.land/rover-video/whep
    }
  
    try {
      const whepUrl = await getWhepUrl();
      log('connecting…');
  
      // ✅ ADD A STUN SERVER (matches what MediaMTX’s UI uses)
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
        // iceCandidatePoolSize: 0  // default is fine
      });
  
      // Build a MediaStream and add tracks as they arrive
      const ms = new MediaStream();
      video.srcObject = ms;
  
      pc.addTransceiver('video', { direction: 'recvonly' });
      pc.addTransceiver('audio', { direction: 'recvonly' });
  
      pc.ontrack = (ev) => {
        ms.addTrack(ev.track);
        console.debug('[pc] ontrack:', ev.track.kind);
      };
  
      pc.oniceconnectionstatechange = () => {
        console.debug('[pc] ice:', pc.iceConnectionState);
        if (pc.iceConnectionState === 'connected') log('playing');
      };
  
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
  
      // Wait briefly for ICE gather (no-trickle style)
      await new Promise(res => {
        if (pc.iceGatheringState === 'complete') return res();
        const to = setTimeout(res, 1000);
        pc.addEventListener('icegatheringstatechange', () => {
          if (pc.iceGatheringState === 'complete') { clearTimeout(to); res(); }
        });
      });
  
      const resp = await fetch(whepUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: pc.localDescription.sdp
      });
      if (!resp.ok) throw new Error(`WHEP ${resp.status}`);
      const answer = await resp.text();
      if (!/^\s*m=video\s/im.test(answer)) throw new Error('answer SDP missing video m-line');
      await pc.setRemoteDescription({ type: 'answer', sdp: answer });
  
      // Start UNMUTED first (fallback to muted if autoplay blocks)
      video.muted = false;
      try {
        await video.play();
        log('playing');
      } catch {
        video.muted = true;
        await video.play().catch(()=>{});
        log('autoplay blocked — started muted');
      }
    } catch (e) {
      err(e.message || e);
    }
  })();
  </script>
  